package service;

import entity.ChuyenBay;
import entity.PhiCong;
import entity.TiepVien;
import java.io.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

public class ChuyenBayManager{
    private final List<ChuyenBay> cblist = new ArrayList<>();
    private final Scanner sc = new Scanner(System.in);
    //Ra vào file chuyenbay.txt
    private final String FILE_PATH = "chuyenbay.txt";

    public ChuyenBayManager(){
        readChuyenBayFromFile();
    }

    public void showChuyenBay(){
        if(cblist.isEmpty()){
            System.out.println("Không có chuyến bay nào.");
            return;
        }

        System.out.println("\n=== Danh sách chuyến bay ===");
        for(ChuyenBay chuyenBay : cblist){
            chuyenBay.displayChuyenBayInfo();
        }
    }

    public void addChuyenBay(){
        System.out.print("Nhập mã chuyến bay: ");      int maChuyenBay = sc.nextInt();sc.nextLine();
        
        System.out.print("Nhập ngày giờ bay: ");       String ngayGioBay = sc.nextLine();
        
        System.out.print("Nhập điểm đến: ");           String diemDen = sc.nextLine();
        
        System.out.print("Nhập giờ di chuyển: ");      String gioDiChuyen = sc.nextLine();
        
        System.out.print("Nhập số ghế: ");             int soGhe = sc.nextInt();
        
        System.out.println("Nhập tên hãng máy bay: "); String hangMayBay = sc.nextLine();hangMayBay = sc.nextLine();
        
        

        ChuyenBay chuyenBay = new ChuyenBay(maChuyenBay, ngayGioBay, diemDen, gioDiChuyen, soGhe, hangMayBay);
        cblist.add(chuyenBay);
        writeChuyenBayToFile();
        System.out.println("Thêm chuyến bay thành công!");

    }

    private void writeChuyenBayToFile(){
        try(BufferedWriter writer = new BufferedWriter(new FileWriter(FILE_PATH))){
            for(ChuyenBay chuyenBay : cblist){
                writer.write(chuyenBay.getMaChuyenBay() + "," +
                        chuyenBay.getNgayGioBay() + "," +
                        chuyenBay.getDiemDen() + "," +
                        chuyenBay.getGioDiChuyen() + "," +
                        chuyenBay.getSoGhe() + "," +
                        chuyenBay.getHangMayBay());
                        
                writer.newLine();

                for(PhiCong phiCong : chuyenBay.getPhiCongList()){
                    writer.write("P," + phiCong.getMaPhiCong() + "," + phiCong.getTenPhiCong());
                    writer.newLine();
                }

                for(TiepVien tiepVien : chuyenBay.getTiepVienList()){
                    writer.write("T," + tiepVien.getMaTiepVien() + "," + tiepVien.getTenTiepVien());
                    writer.newLine();
                }
            }
        } catch(IOException e){
            System.out.println("Lỗi: " + e.getMessage());
        }
    }


    //                   Lấy thông tin chuyến bay từ file


    private void readChuyenBayFromFile(){
        try(BufferedReader reader = new BufferedReader(new FileReader(FILE_PATH))){
            String line;
            while((line = reader.readLine()) != null){
                String[] data = line.split(",");
                if(data.length == 6){
                    ChuyenBay chuyenBay = new ChuyenBay(
                            Integer.parseInt(data[0]),          //Mã chuyến bay
                            data[1],                            //Ngày giờ bay
                            data[2],                            //Điểm đến
                            data[3],                            //TG di chuyển
                            Integer.parseInt(data[4]),          //Số ghế
                            data[5]                             //Hãng
                    );
                    cblist.add(chuyenBay);

                    //Đọc phi công
                    while((line = reader.readLine()) != null && line.startsWith("P")){
                        String[] phiCongData = line.split(",");
                        PhiCong pc = new PhiCong(Integer.parseInt(phiCongData[1]), phiCongData[2]);
                        chuyenBay.addPhiCong(pc);
                    }

                    //Đọc tiếp viên
                    while(line != null && line.startsWith("T")){
                        String[] tiepVienData = line.split(",");
                        TiepVien tv = new TiepVien(Integer.parseInt(tiepVienData[1]), tiepVienData[2]);
                        chuyenBay.addTiepVien(tv);
                        line = reader.readLine();
                    }
                }
            }
        } catch(IOException e){
            System.out.println("Lỗi khi đọc thông tin chuyến bay: " + e.getMessage());
        }
    }
    
}
